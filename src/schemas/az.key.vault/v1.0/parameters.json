{
    "$schema": "http://json-schema.org/draft-07/schema",
    "definitions": {
        "key-vaults": {
            "properties": {
                "value": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "keyVaultName": {
                                "type": "string"
                            },
                            "keyVaultEnableRbac": {
                                "type": "boolean",
                                "default": false
                            },
                            "keyVaultEnableSoftDelete": {
                                "type": "boolean",
                                "default": true
                            },
                            "keyVaultCreationMode": {
                                "type": "string",
                                "oneOf": [
                                    {
                                        "const": "default"
                                    },
                                    {

                                        "const": "recovery"
                                    }
                                ]
                            },
                            "keyVaultSku": {
                                "type" : "object",
                                "properties": {
                                "dev": {
                                    "type": "string",
                                    "oneOf": [
                                        {
                                            "const": "Standard"
                                        },
                                        {
                                            "const": "Premium"
                                        }
                                    ]
                                } ,
                                "qa": {
                                    "type": "string",
                                    "oneOf": [
                                        {
                                            "const": "Standard"
                                        },
                                        {
                                            "const": "Premium"
                                        }
                                    ]
                                } ,
                                "uat": {
                                    "type": "string",
                                    "oneOf": [
                                        {
                                            "const": "Standard"
                                        },
                                        {
                                            "const": "Premium"
                                        }
                                    ]
                                } ,
                                "prd": {
                                    "type": "string",
                                    "oneOf": [
                                        {
                                            "const": "Standard"
                                        },
                                        {
                                            "const": "Premium"
                                        }
                                    ]
                                } 
                                }
                            },
                            "keyVaultDefaultNetworkAccess": {
                                "type":"string",
                                "default": "Allow",
                                "oneOf": [
                                    {
                                        "const":"Allow"
                                    },
                                    {
                                        "const": "Deny"
                                    }
                                ]
                            },
                            "keyVaultPrivateEndpoint": {
                                "oneOf": [
                                    {
                                        "type": "object",
                                        "properties": {
                                            "privateEndpointName": {
                                                "type": "string"
                                            },
                                            "privateEndpointDnsZone": {
                                                "type": "string"
                                            },
                                            "privateEndpointDnsZoneResourceGroup": {
                                                "type": "string",
                                                "description": "The resource group in which the Azure Private DNS Zone belongs to."
                                            },
                                            "privateEndpointVirtualNetwork": {
                                                "type": "string"
                                            },
                                            "privateEndpointVirtualNetworkSubnet": {
                                                "type": "string"
                                            },
                                            "privateEndpointVirtualNetworkResourceGroup": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "privateEndpointName",
                                            "privateEndpointDnsZone",
                                            "privateEndpointDnsZoneResourceGroup",
                                            "privateEndpointVirtualNetwork",
                                            "privateEndpointVirtualNetworkSubnet",
                                            "privateEndpointVirtualNetworkResourceGroup"
                                        ]
                                    },
                                    {
                                        "type": "null"
                                    }
                                ]
                            },
                            "keyVaultVirtualNetworks": {
                                "type":"array",
                                "items":{
                                    "type": "object",
                                    "properties":{
                                        "virtualNetwork":{
                                            "type":"string"
                                        },
                                        "virtualNetworkSubnet":{
                                            "type":"string"
                                        },
                                        "virtualNetworkResourceGroup":{
                                            "type":"string"
                                        }
                                    },
                                    "required": [
                                        "virtualNetwork",
                                        "virtualNetworkSubnet",
                                        "virtualNetworkResourceGroup"
                                    ]

                                }
                            },
                            "keyVaultSecrets": {
                                "type": "array",
                                "description": "Upsert other azure resource secrets, keys, and connection strings into key vault on deployment by referencing those resources",
                                "items": {
                                    "properties": {
                                        "keyVaultSecretName": {
                                            "type": "string"
                                        },
                                        "keyVaultSecretResourceName": {
                                            "type": "string"
                                        },
                                        "keyVaultSecretResourceType": {
                                            "type": "string",
                                            "oneOf": [
                                                {
                                                    "const": "Microsoft.ServiceBus/namespaces/authorizationRules"
                                                },
                                                {
                                                    "const": "Microsoft.EventHub/namespaces/authorizationRules"
                                                },
                                                {
                                                    "const": "Microsoft.Storage/storageAccounts"
                                                },
                                                {
                                                    "const": "Microsoft.DocumentDB/databaseAccounts"
                                                },
                                                {
                                                    "const": "Microsoft.EventGrid/domains"
                                                },
                                                {
                                                    "const": "Microsoft.NotificationHubs/namespaces/authorizationRules"
                                                },
                                                {
                                                    "const": "Microsoft.NotificationHubs/namespaces/notificationHubs/authorizationRules"
                                                }
                                            ]
                                        },
                                        "keyVaultSecretResourceGroupOfResource": {
                                            "type": "string"
                                        }
                                    },
                                    "required": [
                                        "keyVaultSecretName",
                                        "keyVaultSecretResourceName",
                                        "keyVaultSecretResourceType",
                                        "keyVaultSecretResourceGroupOfResource"
                                    ]
                                }
                            },
                            "keyVaultKeys": {
                                "type": "array",
                                "items": {
                                    "properties": {

                                    }
                                }
                            },
                            "keyVaultTags": {
                                "oneOf": [
                                    {
                                        "type": "object",
                                        "patternProperties": {
                                            "^[a-z]": {
                                                "type":"string"
                                            }
                                        },
                                        "minProperties": 1
                                    },
                                    {
                                        "type": "null"
                                    }
                                ]
                            }
                        },
                        "if": {
                            "properties": {
                                "keyVaultEnableRbac": {
                                    "const": true
                                }
                            }
                        },
                        "then": {
                            "properties": {
                                "keyVaultPolicies" : {
                                    "type": "array",
                                    "maxItems": 0
                                }
                            }
                        },
                        "else": {
                            "properties": {
                                "keyVaultPolicies": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "objectId": {
                                                "type": "string"
                                            },
                                            "permissions": {
                                                "type": "object",
                                                "properties": {
                                                    "keys": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string",
                                                            "anyOf": [
                                                                {
                                                                    "const": "Get"
                                                                }
                                                            ]
                                                        }
                                                        
                                                    },
                                                    "secrets": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string",
                                                            "anyOf": [
                                                                {
                                                                    "const": "Get"
                                                                },
                                                                {
                                                                    "const": "List"
                                                                },
                                                                {
                                                                    "const": "Set"
                                                                },
                                                                {
                                                                    "const": "Delete"
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    "certificates": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string",
                                                            "andOf": [
                                                                {
                                                                    "const": "Get"
                                                                }
                                                            ]
                                                        }
                                                    }
                                                },
                                                "required": [
                                                    "keys",
                                                    "secrets",
                                                    "certificates"
                                                ]
                                            }
                                        },
                                        "required": [
                                            "objectId",
                                            "permissions"
                                        ]
                                    }
                                }
                            }
                        },
                        "required": [
                            "keyVaultName",
                            "keyVaultCreationMode",
                            "keyVaultDefaultNetworkAccess",
                            "keyVaultEnableSoftDelete",
                            "keyVaultEnableRbac",
                            "keyVaultVirtualNetworks",
                            "keyVaultSku",
                            "keyVaultPolicies"
                        ]
                    },
                    "minItems": 1
                }
            },
            "required": [
                "value"
            ]
        }
    }
}