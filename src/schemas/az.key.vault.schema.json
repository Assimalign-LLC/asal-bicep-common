{
    "$schema": "http://json-schema.org/draft-07/schema",
    "definitions": {
        "keyVaults": {
            "properties": {
                "value": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {
                                "type": "string",
                                "if": {
                                    "pattern": "@environment"                                            
                                },
                                "then": {
                                    "maxLength": 33
                                },
                                "else": {
                                    "maxLength": 24
                                }
                            },
                            "enableRbacAuthorization": {
                                "type": "boolean",
                                "default": false
                            },
                            "enableSoftDelete": {
                                "type": "boolean",
                                "default": true
                            },
                            "creationMode": {
                                "type": "string",
                                "oneOf": [
                                    {
                                        "const": "default"
                                    },
                                    {

                                        "const": "reccovery"
                                    }
                                ]
                            },
                            "sku": {
                                "type" : "object",
                                "properties": {
                                "dev": {
                                    "type": "string",
                                    "oneOf": [
                                        {
                                            "const": "Standard"
                                        },
                                        {
                                            "const": "Premium"
                                        }
                                    ]
                                } ,
                                "qa": {
                                    "type": "string",
                                    "oneOf": [
                                        {
                                            "const": "Standard"
                                        },
                                        {
                                            "const": "Premium"
                                        }
                                    ]
                                } ,
                                "uat": {
                                    "type": "string",
                                    "oneOf": [
                                        {
                                            "const": "Standard"
                                        },
                                        {
                                            "const": "Premium"
                                        }
                                    ]
                                } ,
                                "prd": {
                                    "type": "string",
                                    "oneOf": [
                                        {
                                            "const": "Standard"
                                        },
                                        {
                                            "const": "Premium"
                                        }
                                    ]
                                } 
                                }
                            },
                            "defaultNetworkAccess": {
                                "type":"string",
                                "default": "Allow",
                                "oneOf": [
                                    {
                                        "const":"Allow"
                                    },
                                    {
                                        "const": "Deny"
                                    }
                                ]
                            },
                            "privateEndpoint": {
                                "oneOf": [
                                    {
                                        "type": "object",
                                        "properties": {
                                            "name": {
                                                "type": "string"
                                            },
                                            "privateDnsZone": {
                                                "type": "string"
                                            },
                                            "privateDnsZoneResourceGroup": {
                                                "type": "string",
                                                "description": ""
                                            },
                                            "virtualNetwork": {
                                                "type": "string"
                                            },
                                            "virtualNetworkSubnet": {
                                                "type": "string"
                                            },
                                            "virtualNetworkResourceGroup": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "name",
                                            "privateDnsZone",
                                            "privateDnsZoneResourceGroup",
                                            "virtualNetwork",
                                            "virtualNetworkSubnet",
                                            "virtualNetworkResourceGroup"
                                        ]
                                    },
                                    {
                                        "type": "null"
                                    }
                                ]
                            },
                            "virtualNetworks": {
                                "type":"array",
                                "items":{
                                    "type": "object",
                                    "properties":{
                                        "virtualNetwork":{
                                            "type":"string"
                                        },
                                        "virtualNetworkSubnet":{
                                            "type":"string"
                                        },
                                        "virtualNetworkResourceGroup":{
                                            "type":"string"
                                        }
                                    },
                                    "required": [
                                        "virtualNetwork",
                                        "virtualNetworkSubnet",
                                        "virtualNetworkResourceGroup"
                                    ]

                                }
                            },
                            "secrets": {
                                "type": "array",
                                "description": "Upsert other azure resource secrets, keys, and connection strings into key vault on deployment by referencing those resources",
                                "items": {
                                    "properties": {
                                        "name": {
                                            "type": "string"
                                        },
                                        "resourceName": {
                                            "type": "string"
                                        },
                                        "resourceType": {
                                            "type": "string",
                                            "oneOf": [
                                                {
                                                    "const": "Microsoft.ServiceBus/namespaces/authorizationRules"
                                                },
                                                {
                                                    "const": "Microsoft.EventHub/namespaces/authorizationRules"
                                                },
                                                {
                                                    "const": "Microsoft.Storage/storageAccounts"
                                                },
                                                {
                                                    "const": "Microsoft.DocumentDB/databaseAccounts"
                                                },
                                                {
                                                    "const": "Microsoft.EventGrid/domains"
                                                },
                                                {
                                                    "const": "Microsoft.NotificationHubs/namespaces/authorizationRules"
                                                },
                                                {
                                                    "const": "Microsoft.NotificationHubs/namespaces/notificationHubs/authorizationRules"
                                                }
                                            ]
                                        },
                                        "resourceGroup": {
                                            "type": "string"
                                        }
                                    },
                                    "required": [
                                        "name",
                                        "resourceName",
                                        "resourceType",
                                        "resourceGroup"
                                    ]
                                }
                            },
                            "keys": {
                                "type": "array",
                                "items": {
                                    "properties": {

                                    }
                                }
                            },
                            "tags": {
                                "oneOf": [
                                    {
                                        "type": "object",
                                        "patternProperties": {
                                            "^[a-z]": {
                                                "type":"string"
                                            }
                                        },
                                        "minProperties": 1
                                    },
                                    {
                                        "type": "null"
                                    }
                                ]
                            }
                        },
                        "if": {
                            "properties": {
                                "enableRbacAuthorization": {
                                    "const": true
                                }
                            }
                        },
                        "then": {
                            "properties": {
                                "policies" : {
                                    "type": "array",
                                    "maxItems": 0
                                }
                            }
                        },
                        "else": {
                            "properties": {
                                "policies": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "objectId": {
                                                "type": "string"
                                            },
                                            "permissions": {
                                                "type": "object",
                                                "properties": {
                                                    "keys": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string",
                                                            "anyOf": [
                                                                {
                                                                    "const": "Get"
                                                                }
                                                            ]
                                                        }
                                                        
                                                    },
                                                    "secrets": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string",
                                                            "anyOf": [
                                                                {
                                                                    "const": "Get"
                                                                },
                                                                {
                                                                    "const": "List"
                                                                },
                                                                {
                                                                    "const": "Set"
                                                                },
                                                                {
                                                                    "const": "Delete"
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    "certificates": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string",
                                                            "andOf": [
                                                                {
                                                                    "const": "Get"
                                                                }
                                                            ]
                                                        }
                                                    }
                                                },
                                                "required": [
                                                    "keys",
                                                    "secrets",
                                                    "certificates"
                                                ]
                                            }
                                        },
                                        "required": [
                                            "objectId",
                                            "permissions"
                                        ]
                                    }
                                }
                            }
                        },
                        "required": [
                            "name",
                            "creationMode",
                            "defaultNetworkAccess",
                            "enableSoftDelete",
                            "enableRbacAuthorization",
                            "virtualNetworks",
                            "sku",
                            "privateEndpoint",
                            "policies",
                            "secrets",
                            "keys",
                            "tags"
                        ]
                    }
                }
            },
            "required": [
                "value"
            ]
        }
    }
}