parameters:
- name: module

stages:
  - stage: dev
    displayName: Release - DEV
    jobs:
      - deployment: release
        environment: 'Development'
        variables: 
        - group: bicep-dev-module-configs
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
                displayName: Checkout
              - task: AzurePowerShell@5
                displayName: "Upcert Bicep Modules"
                condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
                inputs:
                  azureSubscription: $(service-principal)
                  preferredAzurePowerShellVersion: "10.3.0"
                  pwsh: true
                  ScriptType: "FilePath"
                  ScriptPath: "deploy.ps1"
                  ScriptArguments:
                    -moduleName ${{ parameters.module }}
                    -storageAccountName $(storage-account)
                    -storageAccountContainerName $(storage-account-container)
                    -storageAccountResourceGroup $(storage-account-resource-group)
                    -containerRegistryName $(container-registry)
                    -containerRegistryResourceGroup $(container-registry-resource-group)


  - stage: qa
    displayName: Release - QA
    jobs:
      - deployment: release
        environment: 'Quality Assurance'
        variables: 
        - group: bicep-qa-module-configs
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
                displayName: Checkout
              - task: AzurePowerShell@5
                displayName: "Upcert Bicep Modules"
                condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
                inputs:
                  azureSubscription: $(service-principal)
                  preferredAzurePowerShellVersion: "10.3.0"
                  pwsh: true
                  ScriptType: "FilePath"
                  ScriptPath: "deploy.ps1"
                  ScriptArguments:
                    -moduleName ${{ parameters.module }}
                    -storageAccountName $(storage-account)
                    -storageAccountContainerName $(storage-account-container)
                    -storageAccountResourceGroup $(storage-account-resource-group)
                    -containerRegistryName $(container-registry)
                    -containerRegistryResourceGroup $(container-registry-resource-group)
  - stage: uat
    displayName: Release - UAT
    jobs:
      - deployment: release
        environment: 'User Acceptance Testing'
        variables: 
        - group: bicep-qa-module-configs
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
                displayName: Checkout
              - task: AzurePowerShell@5
                displayName: "Upcert Bicep Modules"
                condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
                inputs:
                  azureSubscription: $(service-principal)
                  preferredAzurePowerShellVersion: "10.3.0"
                  pwsh: true
                  ScriptType: "FilePath"
                  ScriptPath: "deploy.ps1"
                  ScriptArguments:
                    -moduleName ${{ parameters.module }}
                    -storageAccountName $(storage-account)
                    -storageAccountContainerName $(storage-account-container)
                    -storageAccountResourceGroup $(storage-account-resource-group)
                    -containerRegistryName $(container-registry)
                    -containerRegistryResourceGroup $(container-registry-resource-group)

  - stage: prd
    displayName: Release - PRD
    jobs:
      - deployment: release
        environment: 'Production'
        variables: 
        - group: bicep-prd-module-configs
        strategy:
          runOnce:
            deploy:
              steps:
              - checkout: self
                displayName: Checkout
              - task: AzurePowerShell@5
                displayName: "Upcert Bicep Modules"
                condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
                inputs:
                  azureSubscription: $(service-principal)
                  preferredAzurePowerShellVersion: "10.3.0"
                  pwsh: true
                  ScriptType: "FilePath"
                  ScriptPath: "deploy.ps1"
                  ScriptArguments:
                    -moduleName ${{ parameters.module }}
                    -storageAccountName $(storage-account)
                    -storageAccountContainerName $(storage-account-container)
                    -storageAccountResourceGroup $(storage-account-resource-group)
                    -containerRegistryName $(container-registry)
                    -containerRegistryResourceGroup $(container-registry-resource-group)

    